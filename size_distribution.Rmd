---
title: "size_selection"
author: "Chandler Sutherland"
date: "2024-12-17"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Copyright Â© Chandler Sutherland Email: [chandlersutherland\@berkeley.edu](mailto:chandlersutherland@berkeley.edu){.email}

Purpose: compare size distribution plots from bioanalyzer for a variety of modifications to the nanoseq protocol. 

```{r}
library(ggplot2)
require(tidyverse)
library(openxlsx)
library(patchwork)
```

# Size selection 

This is all pre-PCR at this point. 

Load raw results from fragment analysis 12/16/2024 from qb3

sample 1 (control)	2.5x
sample 2	1.8x
sample 3	0.9x
sample 4	0.7x
sample 5	reverse 1 (0.55x; 1x)
sample 6	reverse 2 (0.64x; 0.77x)

```{r}
data_path <- "C:\\Users\\chand\\Box Sync\\Krasileva_Lab\\Research\\chandler\\Krasileva Lab\\E19\\fragment analysis\\20241216 raw files\\"
cs5 <- read_csv(paste(data_path, '2024 12 16 14H 48M B1  CS5.csv', sep='')) %>% mutate(sample='CS5')
cs6 <- read_csv(paste(data_path, '2024 12 16 14H 48M B2  CS6.csv', sep='')) %>% mutate(sample='CS6')
cs7 <- read_csv(paste(data_path, '2024 12 16 14H 48M B3  CS7.csv', sep='')) %>% mutate(sample='CS7')
cs8 <- read_csv(paste(data_path, '2024 12 16 14H 48M B4  CS8.csv', sep='')) %>% mutate(sample='CS8')
cs9 <- read_csv(paste(data_path, '2024 12 16 14H 48M B5  CS9.csv', sep='')) %>% mutate(sample='CS9')
cs10 <- read_csv(paste(data_path, '2024 12 16 14H 48M B6  CS10.csv', sep='')) %>% mutate(sample='CS10')

raw_frag <- rbind(cs5, cs6, cs7, cs8, cs9, cs10)

raw_frag <- raw_frag %>% mutate(ampure=case_when(sample=='CS10' ~ 'reverse (0.64x; 0.77x)', 
                                     sample=='CS5' ~ '2.5x', 
                                     sample=='CS6' ~ '1.8x', 
                                     sample=='CS7' ~ '0.9x', 
                                     sample=='CS8' ~ '0.7x', 
                                     sample=='CS9' ~ 'reverse (0.55x; 1x)'))

summary <- read_csv(paste(data_path, '2024 12 16 14H 48M Smear Analysis Result.csv', sep='')) %>% 
  mutate(ampure=case_when(`Sample ID`=='CS10' ~ 'reverse (0.64x; 0.77x)', 
                                     `Sample ID`=='CS5' ~ '2.5x', 
                                     `Sample ID`=='CS6' ~ '1.8x', 
                                     `Sample ID`=='CS7' ~ '0.9x', 
                                     `Sample ID`=='CS8' ~ '0.7x', 
                                     `Sample ID`=='CS9' ~ 'reverse (0.55x; 1x)'))
```

```{r}
size_distro <- ggplot(raw_frag) +
  geom_line(aes(x=`Size (bp)`, y= Intensity, color=ampure))+
  scale_x_log10(limits=c(5,NA), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000,6000))+
  theme_classic()+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')

size_distro
```

Just look at the regular concentrations  
```{r}
forward <- raw_frag %>% filter(sample %in% c('CS5', 'CS6', 'CS7', 'CS8'))

forward_plot <- ggplot(forward) +
  geom_line(aes(x=`Size (bp)`, y= Intensity, color=ampure))+
  scale_x_log10(limits=c(5,4000), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000,6000))+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')+
  ylim(0, 500)+
  theme_classic()

forward_plot
```

Reverse size selection:
```{r}
reverse <- raw_frag %>% filter(sample %in% c('CS9', 'CS10'))

two_side <- ggplot(reverse) +
  geom_line(aes(x=`Size (bp)`, y= Intensity, color=ampure))+
  scale_x_log10(limits=c(5,4000), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000,6000))+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')+
  ylim(0, 500)+
  theme_classic()

two_side
```


Compare to simulated fragment distribution with no size selection 
```{r}
scratch_path <- "//wsl.localhost//Ubuntu//home//chandlersutherland//e19_scratch//"
Chr1 <- read_tsv(paste(scratch_path, 'Chr1_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
Chr2 <- read_tsv(paste(scratch_path, 'Chr2_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
Chr3 <- read_tsv(paste(scratch_path, 'Chr3_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
Chr4 <- read_tsv(paste(scratch_path, 'Chr4_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
Chr5 <- read_tsv(paste(scratch_path, 'Chr5_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
ChrC <- read_tsv(paste(scratch_path, 'ChrC_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))
ChrM <- read_tsv(paste(scratch_path, 'ChrM_fragment_no_size_selection.bed', sep=''), col_names=c('Chr', 'start', 'stop', 'frag'))

sim_frag <- rbind(Chr1, Chr2, Chr3, Chr4, Chr5, ChrC, ChrM)
sim_frag <- sim_frag %>% mutate(frag_size=stop-start)

ggplot(sim_frag)+
  geom_histogram(aes(x=frag_size))+
  theme_classic()+
  labs(title='Simulated distribution of fragment sizes')+
  xlab('fragment size')+
  ylab('count')

summary(sim_frag$frag_size)
```
Most fragments are small, average fragment size is 270, median fragment size 171, max 2987.

```{r}
#using base R density function 
point_7 <- raw_frag %>% filter(sample=='CS8') #0.7x Ampure bead cleanup
density_calc <- density(sim_frag$frag_size, from=11)

density_df <- data.frame(
  x=density_calc$x, 
  y=density_calc$y
)

ggplot()+
  geom_line(data=density_df, aes(x=x, y=y*125000, color='simulated'))+
  geom_line(data=point_7, aes(x=`Size (bp)`, y=Intensity, color='empirical'))+
  scale_x_log10(limits=c(5, 3000), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000))+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')+
  ylim(0, 600)+
  theme_classic()

#geom_density 
ggplot()+
  geom_density(dat=sim_frag, aes(x=frag_size, color='simulated fragment distribution'), kernel='gaussian', bw='nrd0', n=512, bounds=c(1, Inf))+
  geom_line(data=point_7, aes(x=`Size (bp)`, y=Intensity/550, color='empirical fragment distribution'))+
  labs(title='post HpyCH4V digestion fragment size')+
  xlab('bp')+
  ylab('density')+
  ylim(0,1)+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')+
  scale_x_log10(limits=c(5,3000), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000,6000))+
  theme_classic()
```

Not sure why the base R density function and the geom_density function have such different curves for simulated fragment. Played around with most of the parameters to no success, but either way it is less than the empirical distribution. 

Did my two sided cleanup help?
```{r}
ggplot()+
  geom_density(dat=sim_frag, 
               aes(x=frag_size, color='simulated fragment distribution'), 
               kernel='gaussian', bw='nrd0', n=512, bounds=c(1, Inf))+
  geom_line(data=reverse, aes(x=`Size (bp)`, y=Intensity/150, color=ampure))+
  labs(title='post HpyCH4V digestion fragment size')+
  xlab('bp')+
  ylab('density')+
  ylim(0,1)+
  geom_vline(xintercept=200, linetype=2, color='grey')+
  geom_vline(xintercept=1000, linetype=2, color='grey')+
  scale_x_log10(limits=c(5,3000), breaks=c(1, 100, 200, 300, 400,500, 600, 700, 800, 1000, 1500,3000,6000))+
  theme_classic()
```

